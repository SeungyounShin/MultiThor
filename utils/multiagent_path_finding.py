import networkx as nx
from heapq import heappop, heappush
from collections import deque
import time, random

def heuristic(a, b):
    return abs(int(a) - int(b))

def a_star_search(graph, start, goal):
    frontier = [(0, start, [])]
    explored = set()

    while frontier:
        cost, current, path = heappop(frontier)

        if current == goal:
            return path + [goal]

        if current not in explored:
            explored.add(current)
            for neighbour in graph[current]:
                heappush(frontier, (cost + 1 + heuristic(neighbour, goal), neighbour, path + [current]))

    return []

def MAPF(graph, sources, targets):
    order = list(range(len(sources)))  # simple ordering from 0 to n-1
    paths = []
    for i in order:
        new_path = a_star_search(graph, sources[i], targets[i])
        paths.append(new_path.copy()) # add a copy of new_path to paths
    
    # Check for collisions and make lower priority agents wait
    max_len = min(map(len, paths))
    for t in range(max_len):
        positions = [path[t] if t < len(path) else path[-1] for path in paths]
        #print(t, positions)

        for i, pos in enumerate(positions):
            if positions.count(pos) > 1:  # If there's a collision
                # agent priority (i)
                high_priority = min([index for index, value in enumerate(positions) if value == pos]) # agents involved in this position 
                if high_priority!=i:
                    # Make the lower priority agent wait
                    paths[i] = paths[i][:t] + [paths[i][t-1]] +  paths[i][t:]

    # Extend all paths to be of same length
    max_len = max(map(len, paths))
    min_len = min(map(len, paths))
    #for path in paths:
    #    path += [path[-1]] * (max_len - len(path))

    return min_len, paths

if __name__=="__main__":
    # Testing the function
    graph = {'0': ['1', '2', '3', '4', '6', '7'], '1': ['0', '2', '4', '5', '6', '10', '12'], '2': ['0', '1', '3', '6', '7'], '3': ['0', '2', '7', '8', '13'], '4': ['0', '1', '5', '9', '10', '16'], '5': ['1', '4', '6', '10', '11', '12', '17', '19'], '6': ['0', '1', '2', '5', '12'], '7': ['0', '2', '3', '8', '13'], '8': ['3', '7', '13', '14', '20'], '9': ['4', '10', '15', '16', '23'], '10': ['1', '4', '5', '9', '11', '16', '17', '24'], '11': ['5', '10', '12', '17', '18', '19', '25', '26'], '12': ['1', '5', '6', '11', '19', '27'], '13': ['3', '7', '8', '14', '20'], '14': ['8', '13', '20', '21', '28',], '15': ['9', '16', '22', '23', '31'], '16': ['4', '9', '10', '15', '17', '23', '24', '32'], '17': ['5', '10', '11', '16', '18', '24', '25', '33'], '18': ['11', '17', '19', '25', '26'], '19': ['5', '11', '12', '18', '26', '27', '34'], '20': ['8', '13', '14', '21', '28'], '21': ['14', '20', '28', '29', '35'], '22': ['15', '23', '30', '31', '38'], '23': ['9', '15', '16', '22', '24', '31', '32', '39'], '24': ['10', '16', '17', '23', '25', '32', '33', '40'], '25': ['11', '17', '18', '24', '33'], '26': ['11', '18', '19', '27', '34'], '27': ['12', '19', '26', '34'], '28': ['14', '20', '21', '29', '35'], '29': ['21', '28', '35', '36', '41'], '30': ['22', '31', '37', '38', '44'], '31': ['15', '22', '23', '30', '32', '38', '39', '45'], '32': ['16', '23', '24', '31', '33', '39', '40', '46'], '33': ['17', '24', '25', '32', '40', '47'], '34': ['19', '26', '27'], '35': ['21', '28', '29', '36', '41'], '36': ['29', '35', '41', '42', '48'], '37': ['30', '38', '43', '44', '51'], '38': ['22', '30', '31', '37', '39', '44', '45', '52'], '39': ['23', '31', '32', '38', '40', '45', '46', '53'], '40': ['24', '32', '33', '39', '46', '47', '54'], '41': ['29', '35', '36', '42', '48'], '42': ['36', '41', '48', '49', '55'], '43': ['37', '44', '50', '51', '58'], '44': ['30', '37', '38', '43', '45', '51', '52', '59'], '45': ['31', '38', '39', '44', '46', '52', '53', '60'], '46': ['32', '39', '40', '45', '47', '53', '54'], '47': ['33', '40', '46', '54'], '48': ['36', '41', '42', '49', '55'], '49': ['42', '48', '55', '56', '61', '62'], '50': ['43', '51', '57', '58', '65', '66'], '51': ['37', '43', '44', '50', '52', '58', '59', '67'], '52': ['38', '44', '45', '51', '53', '59', '60', '68'], '53': ['39', '45', '46', '52', '54', '60'], '54': ['40', '46', '47', '53'], '55': ['42', '48', '49', '56', '61'], '56': ['49', '55', '61', '62', '63', '69', '71'], '57': ['50', '58', '64', '65', '66', '74', '75'], '58': ['43', '50', '51', '57', '59', '65', '67', '76'], '59': ['44', '51', '52', '58', '60', '67', '68', '78'], '60': ['45', '52', '53', '59', '68'], '61': ['49', '55', '56', '63', '69'], '62': ['49', '56', '63', '70', '71', '81'], '63': ['56', '61', '62', '69', '71', '72', '79', '82'], '64': ['57', '65', '66', '73', '74', '75', '84', '85'], '65': ['50', '57', '58', '64', '67', '74', '76', '86'], '66': ['50', '57', '64', '75', '77', '87'], '67': ['51', '58', '59', '65', '68', '76', '78', '88'], '68': ['52', '59', '60', '67', '78'], '69': ['56', '61', '63', '72', '79'], '70': ['62', '71', '80', '81', '91'], '71': ['56', '62', '63', '70', '72', '81', '82', '92'], '72': ['63', '69', '71', '79', '82'], '73': ['64', '74', '75', '83', '84', '85', '93', '94'], '74': ['57', '64', '65', '73', '76', '84', '86', '95'], '75': ['57', '64', '66', '73', '77', '85', '87', '96'], '76': ['58', '65', '67', '74', '78', '86', '88', '97'], '77': ['66', '75', '87', '89', '98'], '78': ['59', '67', '68', '76', '88'], '79': ['63', '69', '72'], '80': ['70', '81', '90', '91', '101'], '81': ['62', '70', '71', '80', '82', '91', '92', '102'], '82': ['63', '71', '72', '81', '92'], '83': ['73', '84', '85', '93', '94'], '84': ['64', '73', '74', '83', '86', '93', '95', '103'], '85': ['64', '73', '75', '83', '87', '94', '96', '104'], '86': ['65', '74', '76', '84', '88', '95', '97', '105'], '87': ['66', '75', '77', '85', '89', '96', '98', '106'], '88': ['67', '76', '78', '86', '97'], '89': ['77', '87', '98', '99', '107'], '90': ['80', '91', '100', '101', '110'], '91': ['70', '80', '81', '90', '92', '101', '102', '111'], '92': ['71', '81', '82', '91', '102'], '93': ['73', '83', '84', '95', '103'], '94': ['73', '83', '85', '96', '104'], '95': ['74', '84', '86', '93', '97', '103', '105', '112'], '96': ['75', '85', '87', '94', '98', '104', '106', '113'], '97': ['76', '86', '88', '95', '105'], '98': ['77', '87', '89', '96', '99', '106', '107', '114'], '99': ['89', '98', '107', '108', '115', '116'], '100': ['90', '101', '109', '110', '119'], '101': ['80', '90', '91', '100', '102', '110', '111', '120'], '102': ['81', '91', '92', '101', '111'], '103': ['84', '93', '95', '105', '112'], '104': ['85', '94', '96', '106', '113'], '105': ['86', '95', '97', '103', '112'], '106': ['87', '96', '98', '104', '107', '113', '114', '121'], '107': ['89', '98', '99', '106', '108', '114', '115', '122'], '108': ['99', '107', '115', '116', '117', '123', '124'], '109': ['100', '110', '118', '119', '127'], '110': ['90', '100', '101', '109', '111', '119', '120', '128'], '111': ['91', '101', '102', '110', '120'], '112': ['95', '103', '105'], '113': ['96', '104', '106', '114', '121'], '114': ['98', '106', '107', '113', '115', '121', '122', '129'], '115': ['99', '107', '108', '114', '117', '122', '123', '130'], '116': ['99', '108', '117', '124'], '117': ['108', '115', '116', '123', '124', '125', '131'], '118': ['109', '119', '126', '127', '134', '135'], '119': ['100', '109', '110', '118', '120', '127', '128', '136'], '120': ['101', '110', '111', '119', '128'], '121': ['106', '113', '114', '122', '129'], '122': ['107', '114', '115', '121', '123', '129', '130', '137'], '123': ['108', '115', '117', '122', '125', '130', '131', '138'], '124': ['108', '116', '117', '125'], '125': ['117', '123', '124', '131', '132', '139'], '126': ['118', '127', '133', '134', '135', '140', '142'], '127': ['109', '118', '119', '126', '128', '135', '136', '143'], '128': ['110', '119', '120', '127', '136'], '129': ['114', '121', '122', '130', '137'], '130': ['115', '122', '123', '129', '131', '137', '138', '144'], '131': ['117', '123', '125', '130', '132', '138', '139', '145'], '132': ['125', '131', '134', '139', '140', '146'], '133': ['126', '134', '135', '140', '141', '142', '146', '148'], '134': ['118', '126', '132', '133', '140'], '135': ['118', '126', '127', '133', '136', '142', '143', '149'], '136': ['119', '127', '128', '135', '143'], '137': ['122', '129', '130', '138', '144'], '138': ['123', '130', '131', '137', '139', '144', '145', '150'], '139': ['125', '131', '132', '138', '140', '145', '146', '151'], '140': ['126', '132', '133', '134', '139', '141', '146'], '141': ['133', '140', '142', '146', '147', '148', '151', '153'], '142': ['126', '133', '135', '141', '143', '148', '149', '154'], '143': ['127', '135', '136', '142', '149'], '144': ['130', '137', '138', '145', '150'], '145': ['131', '138', '139', '144', '146', '150', '151', '155'], '146': ['132', '133', '139', '140', '141', '145', '147', '151'], '147': ['141', '146', '148', '151', '152', '153', '155', '156'], '148': ['133', '141', '142', '147', '149', '153', '154', '157'], '149': ['135', '142', '143', '148', '154', '158'], '150': ['138', '144', '145', '151', '155'], '151': ['139', '141', '145', '146', '147', '150', '152', '155'], '152': ['147', '151', '153', '155', '156'], '153': ['141', '147', '148', '152', '154', '156', '157', '159'], '154': ['142', '148', '149', '153', '157', '158', '160'], '155': ['145', '147', '150', '151', '152'], '156': ['147', '152', '153', '157', '159'], '157': ['148', '153', '154', '156', '158', '159', '160', '161'], '158': ['149', '154', '157', '160'], '159': ['153', '156', '157', '160', '161'], '160': ['154', '157', '158', '159', '161'], '161': ['157', '159', '160']}
    sources = ['0', '21']
    #targets = ['21', '0']
    #targets = ['92', '0']
    targets = ['55', '12']

    start = time.time()
    print(MAPF(graph, sources, targets))
    end = time.time()
    print(f'time : {end-start}')
